<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=1920, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Temps d'attente — Quick</title>
<link rel="icon" type="image/png" href="/static/favicon.png" />
<style>
  :root{
    --q-red:#E31E24; --q-red-dark:#B7161B; --q-white:#fff;
    --logoH: 140px;  /* Taille fixe pour contrôle précis */
    --dim: 1;
  }
  
  /* Force dimensions exactes */
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body {
    width: 1920px !important;
    height: 1080px !important;
    overflow: hidden !important;
    margin: 0 !important;
    padding: 0 !important;
  }
  .hidden { display: none !important; }

  /* Background */
  body {
    color: var(--q-white);
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    background: radial-gradient(1200px 800px at 20% 10%, #ff5151 0%, var(--q-red) 40%, var(--q-red-dark) 100%);
  }
  
  .stage {
    position: relative;
    width: 1920px;
    height: 1080px;
    overflow: hidden;
    filter: brightness(var(--dim));
  }

  /* Panel - sans marges pour utiliser tout l'écran */
  .panel {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(255,255,255,.05);
    border: 1px solid rgba(255,255,255,.15);
    backdrop-filter: blur(8px);
    box-shadow: 0 20px 50px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.1);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 30px 40px;
    transform: translateZ(0);
  }
  
  /* Fond animé léger */
  .panel::before {
    content: "";
    position: absolute;
    inset: -5%;
    pointer-events: none;
    background: radial-gradient(40% 30% at var(--spot-x,20%) var(--spot-y,30%), rgba(255,255,255,.12), transparent 60%);
    mix-blend-mode: screen;
    opacity: .5;
    animation: spot 22s ease-in-out infinite alternate;
  }
  @keyframes spot {
    0%   { --spot-x: 20%; --spot-y: 30%; }
    100% { --spot-x: 75%; --spot-y: 60%; }
  }

  /* Bordure pulsée subtile */
  .borderPulse {
    position: absolute;
    inset: 0;
    pointer-events: none;
    box-shadow: 0 0 0 2px rgba(255,255,255,.4) inset;
    opacity: .3;
    animation: borderPulse 5s ease-in-out infinite;
  }
  @keyframes borderPulse {
    0%, 100% { opacity: .2; }
    50% { opacity: .5; }
  }

  /* Pluie */
  .rain {
    position: absolute;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
  }
  .rain::before {
    content: "";
    position: absolute;
    inset: -30% 0;
    background: linear-gradient(to bottom, rgba(255,255,255,.14), rgba(255,255,255,0) 60%);
    -webkit-mask: repeating-linear-gradient(to right, rgba(0,0,0,0) 0 20px, rgba(0,0,0,1) 20px 21px);
    mask: repeating-linear-gradient(to right, rgba(0,0,0,0) 0 20px, rgba(0,0,0,1) 20px 21px);
    opacity: .2;
    animation: rainSlide 8s linear infinite;
  }
  @keyframes rainSlide {
    from { transform: translateY(-8%); }
    to { transform: translateY(8%); }
  }

  /* Logo - position fixe en haut */
  .brand {
    position: absolute;
    top: 15px;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3;
    pointer-events: none;
    animation: dropin 500ms ease-out both;
  }
  .brand img {
    height: var(--logoH);
    width: auto;
    display: block;
  }
  @keyframes dropin {
    from { opacity: 0; transform: translateY(-12px); }
    to { opacity: 1; transform: none; }
  }
  
  .brand.flare::before {
    content: "";
    position: absolute;
    width: 140%;
    height: 60%;
    top: 20%;
    left: -20%;
    pointer-events: none;
    background: linear-gradient(120deg, rgba(255,255,255,0), rgba(255,255,255,.8), rgba(255,255,255,0));
    filter: blur(12px);
    opacity: .45;
    animation: logoFlare 1100ms ease-out;
  }
  @keyframes logoFlare {
    from { transform: translateX(-60%) rotate(10deg); }
    to { transform: translateX(60%) rotate(10deg); }
  }

  /* Contenu central - bien espacé */
  .timeWrap {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    justify-content: center;
    gap: 16px;
    padding-top: 160px; /* Espace pour le logo */
  }

  /* Titre - taille optimale pour lisibilité */
  .headline {
    font-weight: 800;
    letter-spacing: 0.5px;
    opacity: .98;
    line-height: 1.1;
    font-size: 48px; /* Fixe pour contrôle précis */
    margin: 0;
  }
  .headline .commit {
    display: block;
    font-weight: 900;
  }
  .headline .lead {
    display: block;
    font-weight: 800;
  }

  /* Valeur - TRÈS GRANDE pour visibilité de loin */
  .value {
    font-weight: 900;
    line-height: 0.9;
    letter-spacing: 0.02em;
    text-align: center;
    color: #fff;
    text-shadow: none;
    margin-top: 10px;
    will-change: transform;
  }
  .value.size-1 { font-size: 280px; } /* 0-9 : ÉNORME */
  .value.size-2 { font-size: 240px; } /* 10-99 */
  .value.size-3 { font-size: 200px; } /* 100+ */

  /* Gradient à l'update */
  .value.gradient {
    color: transparent;
    background: linear-gradient(180deg, #ffffff 0%, #ffd0d0 40%, #ffffff 80%);
    background-size: 100% 200%;
    -webkit-background-clip: text;
    background-clip: text;
    animation: gradFlow 600ms ease-out both;
  }
  @keyframes gradFlow {
    from { background-position: 0% 0%; }
    to { background-position: 0% 100%; }
  }

  /* Animations */
  .flip { animation: flipIn 360ms cubic-bezier(.2,.9,.2,1); }
  @keyframes flipIn {
    0% { transform: rotateX(70deg); opacity: .55; }
    60% { transform: rotateX(-10deg); opacity: 1; }
    100% { transform: rotateX(0); }
  }
  
  .tick { animation: pop 200ms ease-out; }
  @keyframes pop {
    0% { transform: scale(0.96); }
    60% { transform: scale(1.06); }
    100% { transform: scale(1); }
  }

  /* Unité */
  .unit {
    font-weight: 900;
    font-size: 72px; /* Grande mais pas écrasante */
    margin-top: 10px;
  }

  /* Particules */
  .valueWrap {
    position: relative;
    display: inline-grid;
    place-items: center;
  }
  #particles {
    position: absolute;
    inset: 0;
    width: 120%;
    height: 120%;
    transform: translateZ(0);
    pointer-events: none;
  }

  /* Offre - bien visible avec image */
  .offer {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
    max-width: 90%;
    font-weight: 700;
    text-align: center;
    font-size: 36px; /* Taille lisible de loin */
    margin-top: 20px;
  }
  
  .product-zoom {
    animation: pulse-zoom 6s ease-in-out infinite;
    transform-origin: 50% 50%;
  }
  @keyframes pulse-zoom {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.15); } /* Zoom visible */
  }
  
  .offer-img {
    height: 180px; /* Taille fixe, bien visible */
    width: auto;
    border-radius: 16px;
    background: #fff;
    padding: 12px;
    box-shadow: 0 16px 32px rgba(0,0,0,.35);
    outline: 1px solid rgba(0,0,0,.06);
  }

  /* Flash du panel à l'update */
  .panel.flash {
    animation: panelFlash 380ms ease-out;
  }
  @keyframes panelFlash {
    0% {
      box-shadow: 0 20px 50px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.1);
      transform: translateZ(0);
    }
    50% {
      box-shadow: 0 40px 90px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.15);
      transform: translateZ(0) scale(1.002);
    }
    100% {
      box-shadow: 0 20px 50px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.1);
      transform: translateZ(0);
    }
  }

  /* Réduire animations si préférence utilisateur */
  @media (prefers-reduced-motion: reduce) {
    * {
      animation: none !important;
      transition: none !important;
    }
  }
</style>
</head>
<body>
  <meta id="init"
        data-initial="{{ initial }}"
        data-offer="{{ (offer or '') | e }}"
        data-show-offer="{{ 'true' if show_offer else 'false' }}">

  <main class="stage" id="stage">
    <header class="brand" id="brand">
      <img src="/static/quick-logo.png" alt="Quick" />
    </header>

    <section class="panel" id="panel">
      <div class="borderPulse" aria-hidden="true"></div>
      <div class="rain" aria-hidden="true"></div>

      <div id="timeWrap" class="timeWrap">
        <div class="headline">
          <span class="commit">On s'engage&nbsp;!</span>
          <span class="lead">Vous serez servi en</span>
        </div>

        <div class="valueWrap" id="valueWrap">
          <canvas id="particles"></canvas>
          <div id="val" class="value size-1">0</div>
        </div>

        <div class="unit" id="unit">minutes</div>

        <div id="offerWrap" class="offer hidden">
          <span id="offerText"></span>
          <img id="offerImg" src="/static/products/expresso.png" alt="Produit offert" class="offer-img product-zoom">
        </div>
      </div>
    </section>
  </main>

  <script>
    const valueEl = document.getElementById("val");
    const unitEl = document.getElementById("unit");
    const offerWrap = document.getElementById("offerWrap");
    const offerEl = document.getElementById("offerText");
    const offerImg = document.getElementById("offerImg");
    const initEl = document.getElementById('init');
    const wrapEl = document.getElementById('valueWrap');
    const panelEl = document.getElementById('panel');
    const brandEl = document.getElementById('brand');
    const canvas = document.getElementById('particles');
    const ctx = canvas.getContext('2d');

    const INIT = {
      initial: parseInt(initEl?.dataset.initial ?? '0', 10),
      offer: (initEl?.dataset.offer ?? ''),
      showOffer: (initEl?.dataset.showOffer ?? 'false') === 'true'
    };

    // Dim nocturne
    (function nightDim(){
      const h = new Date().getHours();
      const dim = (h >= 20 || h < 7) ? 0.9 : 1;
      document.documentElement.style.setProperty('--dim', String(dim));
    })();

    // Produits
    const imgForOffer = (txt) => {
      const t = (txt || "").toLowerCase();
      if (t.includes("muffin")) return "/static/products/muffinchocobanane.png";
      if (t.includes("cookie")) return "/static/products/cookietriochoco.png";
      if (t.includes("café") || t.includes("expresso")) return "/static/products/expresso.png";
      if (t.includes("beignet") || t.includes("trio")) return "/static/products/trio.png";
      if (t.includes("bigout")) return "/static/products/bigout_choco.png";
      if (t.includes("churros")) return "/static/products/churros.jpg";
      if (t.includes("fondant")) return "/static/products/fondant.jpg";
      return "/static/products/expresso.png";
    };

    function setOffer(txt, show) {
      txt = (txt ?? "").trim();
      if (!txt || !show) {
        offerWrap.classList.add('hidden');
        return;
      }
      offerWrap.classList.remove('hidden');
      offerEl.textContent = "Sinon, on vous offre " + txt.replace(/espresso/i, 'expresso');
      offerImg.src = imgForOffer(txt);
      offerImg.alt = "Produit offert : " + txt;
      offerImg.classList.remove('product-zoom');
      void offerImg.offsetWidth;
      offerImg.classList.add('product-zoom');
    }

    function applyValueSizing(n) {
      valueEl.classList.remove("size-1", "size-2", "size-3");
      const d = String(n).length;
      valueEl.classList.add(d === 1 ? "size-1" : d === 2 ? "size-2" : "size-3");
    }

    function animateValue() {
      [valueEl, unitEl].forEach(el => {
        el.classList.remove('flip', 'tick');
        void el.offsetWidth;
        el.classList.add('flip', 'tick');
      });
      valueEl.classList.remove('gradient');
      void valueEl.offsetWidth;
      valueEl.classList.add('gradient');
      panelEl.classList.remove('flash');
      void panelEl.offsetWidth;
      panelEl.classList.add('flash');
      burstParticles();
    }

    function setValue(n) {
      valueEl.textContent = String(n);
      unitEl.textContent = (n === 1 ? "minute" : "minutes");
      applyValueSizing(n);
      animateValue();
    }

    // Particules
    let particles = [];
    function resizeCanvas() {
      const rect = wrapEl.getBoundingClientRect();
      canvas.width = Math.ceil(rect.width * devicePixelRatio);
      canvas.height = Math.ceil(rect.height * devicePixelRatio);
      canvas.style.width = rect.width + "px";
      canvas.style.height = rect.height + "px";
      ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
    }

    function burstParticles() {
      const rect = wrapEl.getBoundingClientRect();
      const cx = rect.width / 2, cy = rect.height / 2;
      const count = 28;
      for (let i = 0; i < count; i++) {
        const a = (Math.PI * 2) * (i / count) + Math.random() * 0.4;
        const sp = 2 + Math.random() * 3;
        particles.push({
          x: cx, y: cy,
          vx: Math.cos(a) * sp,
          vy: Math.sin(a) * sp,
          life: 520 + Math.random() * 320,
          size: 2 + Math.random() * 3,
          alpha: 1
        });
      }
    }

    let lastT = 0;
    function tickParticles(ts) {
      if (!lastT) lastT = ts;
      const dt = ts - lastT;
      lastT = ts;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const fade = dt * 0.0018;
      for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.vx *= 0.985;
        p.vy *= 0.985;
        p.alpha -= fade;
        if (p.alpha <= 0) {
          particles.splice(i, 1);
          continue;
        }
        ctx.globalAlpha = Math.max(0, p.alpha);
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fillStyle = "rgba(255,255,255,0.95)";
        ctx.fill();
      }
      requestAnimationFrame(tickParticles);
    }

    // Logo flare
    function scheduleLogoFlare() {
      const delay = 22000 + Math.random() * 12000;
      setTimeout(() => {
        brandEl.classList.add('flare');
        setTimeout(() => brandEl.classList.remove('flare'), 1200);
        scheduleLogoFlare();
      }, delay);
    }

    // SSE
    function connect() {
      const evt = new EventSource("/stream");
      evt.onmessage = (ev) => {
        const parts = String(ev.data || "").split("|");
        const w = parts[0] ?? "0";
        const off = parts[1] ?? "";
        const mode = parts[2] ?? "time";
        const show = parts[3] ?? "1";
        if (mode !== "time") {
          window.location.href = "/screen";
          return;
        }
        const n = parseInt(w, 10);
        if (!Number.isNaN(n)) setValue(n);
        setOffer(off, show === "1");
      };
      evt.onerror = () => {
        evt.close();
        setTimeout(connect, 1200);
      };
    }

    // Boot
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    requestAnimationFrame(tickParticles);

    setValue(INIT.initial);
    setOffer(INIT.offer, INIT.showOffer);
    scheduleLogoFlare();
    connect();
  </script>
</body>
</html>